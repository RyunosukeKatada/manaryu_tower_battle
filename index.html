from base64 import b64encode
from PIL import Image
from io import BytesIO

# ライオン・パンダ・ウサギのシンプルなアイコンをそれぞれ64x64の画像として生成
# ここでは色のついた四角で代用（本来は画像を読み込む）
def create_color_block(color):
    img = Image.new("RGBA", (64, 64), color)
    buffer = BytesIO()
    img.save(buffer, format="PNG")
    return b64encode(buffer.getvalue()).decode()

lion_base64 = create_color_block((255, 204, 0))   # yellow
panda_base64 = create_color_block((255, 255, 255))  # white
rabbit_base64 = create_color_block((255, 192, 203))  # pink

html_output = f"""
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>タワーバトル - 完全版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {{
      margin: 0; padding: 0; overflow: hidden;
      background: #eef; font-family: sans-serif;
      touch-action: none;
    }}
    canvas {{ display: block; }}
    #dropButton {{
      position: absolute; bottom: 20px; left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px; font-size: 20px;
      background: #ffcc00; border: 2px solid #888;
      border-radius: 10px; cursor: pointer; z-index: 10;
    }}
    #liveScore {{
      position: absolute; top: 20px; right: 20px;
      font-size: 20px; background: rgba(255,255,255,0.8);
      padding: 8px 16px; border-radius: 10px;
      z-index: 10;
    }}
    #gameover {{
      position: absolute; top: 40%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px; color: red; font-weight: bold;
      background: rgba(255,255,255,0.8); padding: 20px;
      border-radius: 12px; display: none; z-index: 11;
    }}
    #reset {{
      position: absolute; top: 55%; left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px; font-size: 16px;
      border: 1px solid #888; border-radius: 8px;
      background: #fff; cursor: pointer;
      display: none; z-index: 11;
    }}
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="liveScore">スコア: 0個</div>
  <div id="gameover">GAME OVER</div>
  <button id="reset">リセット</button>
  <button id="dropButton">ドロップ</button>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <script id="imageData" type="application/json">
  {{
    "lion": {{
      "data": "data:image/png;base64,{lion_base64}",
      "weight": 3
    }},
    "panda": {{
      "data": "data:image/png;base64,{panda_base64}",
      "weight": 2
    }},
    "rabbit": {{
      "data": "data:image/png;base64,{rabbit_base64}",
      "weight": 1
    }}
  }}
  </script>
  <script>
    const {{ Engine, Render, Runner, World, Bodies, Events }} = Matter;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const engine = Engine.create();
    const world = engine.world;
    engine.gravity.y = 0.4;

    const render = Render.create({{
      canvas: canvas,
      engine: engine,
      options: {{
        width: canvas.width,
        height: canvas.height,
        wireframes: false,
        background: '#eef'
      }}
    }});
    Render.run(render);
    Runner.run(Runner.create(), engine);

    const platform = Bodies.rectangle(canvas.width / 2, canvas.height - 60, canvas.width * 0.6, 40, {{
      isStatic: true, render: {{ fillStyle: '#888' }}
    }});
    World.add(world, platform);

    const imageData = JSON.parse(document.getElementById('imageData').textContent);
    const animalList = Object.entries(imageData).map(([name, val]) => {{
      return {{ name, texture: val.data, weight: val.weight }};
    }});

    function getWeightedAnimal() {{
      const total = animalList.reduce((sum, a) => sum + a.weight, 0);
      let r = Math.random() * total;
      for (let a of animalList) {{
        if (r < a.weight) return a;
        r -= a.weight;
      }}
    }}

    let animals = [];
    let gameOver = false;
    const dropButton = document.getElementById("dropButton");
    const resetButton = document.getElementById("reset");
    const scoreDiv = document.getElementById("liveScore");
    const gameoverDiv = document.getElementById("gameover");

    dropButton.onclick = () => {{
      if (gameOver) return;
      const animal = getWeightedAnimal();
      const size = 64;
      const x = canvas.width / 2;
      const body = Bodies.rectangle(x, 0, size, size, {{
        restitution: 0.2,
        friction: 0.8,
        render: {{
          sprite: {{
            texture: animal.texture,
            xScale: 1,
            yScale: 1
          }}
        }}
      }});
      World.add(world, body);
      animals.push(body);
    }};

    resetButton.onclick = () => {{
      animals.forEach(a => World.remove(world, a));
      animals = [];
      gameOver = false;
      resetButton.style.display = 'none';
      gameoverDiv.style.display = 'none';
      scoreDiv.textContent = "スコア: 0個";
    }};

    Events.on(engine, 'beforeUpdate', () => {{
      if (gameOver) return;
      for (const body of animals) {{
        const bottom = body.position.y + body.bounds.max.y - body.position.y;
        if (
          bottom > platform.position.y + 40 &&
          (body.position.x < platform.position.x - canvas.width * 0.3 ||
           body.position.x > platform.position.x + canvas.width * 0.3)
        ) {{
          gameOver = true;
          gameoverDiv.style.display = 'block';
          resetButton.style.display = 'block';
        }}
      }}
      const score = animals.filter(b =>
        b.position.y + b.bounds.max.y - b.position.y <= platform.position.y + 40
      ).length;
      scoreDiv.textContent = `スコア: ${{score}}個`;
    }});
  </script>
</body>
</html>
"""

html_output
